services:
  # MQTT Broker - receives data from RTL_433 client
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: weather-mosquitto
    ports:
      - "1883:1883"    # MQTT standard port
      - "9001:9001"    # WebSocket port
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto_data:/mosquitto/data
      - mosquitto_logs:/mosquitto/log
    restart: unless-stopped
    networks:
      - weather-network

  # InfluxDB - time-series database for storing weather data
  influxdb:
    image: influxdb:1.8
    container_name: weather-influxdb
    environment:
      INFLUXDB_DB: ${INFLUXDB_DB:-weather_data}
      INFLUXDB_ADMIN_USER: ${INFLUXDB_USER:-admin}
      INFLUXDB_ADMIN_PASSWORD: ${INFLUXDB_PASSWORD:-adminpassword}
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb
    restart: unless-stopped
    networks:
      - weather-network

  # MQTT to InfluxDB Bridge - forwards MQTT messages to InfluxDB
  mqtt-influxdb-bridge:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: weather-mqtt-bridge
    depends_on:
      - mosquitto
      - influxdb
    restart: unless-stopped
    networks:
      - weather-network
    environment:
      MQTT_HOST: ${MQTT_HOST:-mosquitto}
      MQTT_PORT: ${MQTT_PORT:-1883}
      MQTT_TOPIC: ${MQTT_TOPIC:-rtl_433/#}
      INFLUXDB_HOST: ${INFLUXDB_HOST:-influxdb}
      INFLUXDB_PORT: ${INFLUXDB_PORT:-8086}
      INFLUXDB_DB: ${INFLUXDB_DB:-weather_data}
      INFLUXDB_USER: ${INFLUXDB_USER:-admin}
      INFLUXDB_PASSWORD: ${INFLUXDB_PASSWORD:-adminpassword}

volumes:
  mosquitto_data:
  mosquitto_logs:
  influxdb_data:

networks:
  weather-network:
    driver: bridge
